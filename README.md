# Документация по проекту "Route-Tracker"

## Описание

**route-tracker** — это телеграм-бот, разработанный на Python с использованием aiogram 3 и базы данных SQLite. Бот предназначен для водителей автобусов, чтобы они могли оперативно регистрировать количество пассажиров на остановках. Все собранные данные автоматически записываются в Google Таблицу.

## 1. Требования

- Python 3.10+ (рекомендуется 3.13)

## 2. Установка и Запуск

Выполните следующие шаги в терминале или командной строке для настройки и запуска проекта.

### Шаг 1: Клонирование репозитория

Откройте терминал в папке, где вы хотите разместить проект, и выполните команду:

```bash
git clone https://github.com/Umar151515/route-tracker.git
```

Затем перейдите в папку проекта:

```bash
cd route-tracker
```

### Шаг 2: Создание и активация виртуальной среды

Рекомендуется использовать виртуальную среду для изоляции зависимостей проекта.

**Для Windows (CMD/PowerShell):**

```cmd
# Создать виртуальную среду
python -m venv venv
# Активировать среду
.\venv\Scripts\activate
```

**Для Linux/macOS:**

```bash
# Создать виртуальную среду
python3 -m venv venv
# Активировать среду
source venv/bin/activate
```

### Шаг 3: Установка зависимостей

Убедитесь, что ваша виртуальная среда активирована, и выполните:

```bash
pip install -r requirements.txt
```

### Шаг 4: Первый запуск (Автоматическое создание файлов)

Выполните первый запуск.

```bash
python main.py
# или для Linux / macOS
python3 main.py
```

При первом запуске программа создаст необходимые папки/файлы и завершится с ошибкой, сообщающим, что нужно заполнить файл `.env`.

После этого запуска в проекте появятся:

- Папка `data/`
- Файлы `data/data.db` (база данных) и `data/app.log` (файл логов)
- Файл `configs/.env`

### Шаг 5: Конфигурация

Теперь необходимо настроить переменные окружения и API.

#### 5.1. Файл `.env`

Откройте созданный файл `configs/.env` и заполните его:

```env
TELEGRAM_BOT_TOKEN=ВАШ_ТОКЕН_ОТ_TELEGRAM_БОТА
GOOGLE_SHEET_NAME=Лист1
GOOGLE_SHEET_ID=ВАШ_ID_ГУГЛ_ТАБЛИЦЫ
```

- `GOOGLE_SHEET_NAME`: Имя листа в вашей таблице (по умолчанию Лист1)
- `GOOGLE_SHEET_ID`: ID вашей таблицы. Вы можете найти его в URL таблицы:  
  `https://docs.google.com/spreadsheets/d/{ЗДЕСЬ_ВАШ_ID}/edit...`

#### 5.2. Google Sheets API

Вам необходимо получить JSON-файл с ключами для сервисного аккаунта Google API и предоставить этому аккаунту доступ (с правами редактора) к вашей Google Таблице.

**Подробную инструкцию можно найти в этом видео:**  
https://www.youtube.com/watch?v=zCEJurLGFRk

После получения файла:

1. Переименуйте его в `google_sheets_key.json`
2. Поместите этот файл в папку `configs/`

### Шаг 6: Повторный запуск и настройка администратора

Снова запустите бота:

```bash
python main.py
# или для Linux / macOS
python3 main.py
```

При первом успешном запуске, если в базе данных не будет найдено ни одного администратора, бот запустит настройку в терминале.

Следуйте инструкциям в терминале, чтобы добавить первого администратора.

После успешной настройки или при последующих запусках в терминале появится сообщение:

```
[INFO] - Бот запущен
```

## 3. Структура Проекта (Для кастомизации)

```
.
├── app/         # Бизнес-логика, тексты и обработчики
├── configs/     # Файлы конфигурации
│   ├── app.json         # Настройки приложения
│   ├── .env             # Секретные ключи
│   └── google_sheets_key.json # Ключ Google API (необходимо добавить)
├── core/
├── data/        # Данные (создаются автоматически)
│   ├── app.log
│   └── data.db
├── utils/       # Вспомогательные инструменты
│   └── text/
│       └── processing/
│           └── check.py # Функции валидации
└── main.py      # Точка входа
```

### Файлы, которые можно настраивать:

#### `configs/app.json`

Этот файл содержит основные настройки логики приложения:

```json
{
    "time_zone": "Asia/Bishkek",
    "min_passenger_count": 0,
    "max_passenger_count": 100
}
```

- `time_zone`: Часовой пояс для фиксации времени регистрации. Используйте Идентификатор часового пояса IANA (например, Europe/Moscow)
- `min_passenger_count`: Минимальное число пассажиров для регистрации
- `max_passenger_count`: Максимальное число пассажиров для регистрации

#### `utils/text/processing/check.py`

Этот файл содержит регулярные выражения (regex) для проверки вводимых админом данных. Вы можете изменить их при необходимости.

- `PHONE_RE`: Проверка номера телефона
- `NAME_RE`: Проверка имени пользователя
- `BUS_NUMBER_RE`: Проверка номера автобуса
- `STOP_NAME_RE`: Проверка названия остановки

## 4. Функционал Бота

### 4.1. Регистрация

- Незарегистрированный пользователь не имеет доступа к боту
- При попытке старта бот предложит проверить регистрацию по номеру телефона
- Пользователь должен нажать кнопку "Поделиться номером"
- Если этот номер телефона предварительно добавлен администратором в базу данных, бот авторизует пользователя и откроет ему доступ

### 4.2. Общие команды

- `/menu`: Вызов главного меню

### 4.3. Роль: Водитель

#### Команды

- `/my_details` (или кнопка "Мои данные"): Показывает информацию о водителе (Имя, Номер автобуса, Роль, ID, Закрепленные остановки)

#### Регистрация остановки

1. Водитель вводит число пассажиров (оно должно быть в диапазоне, указанном в `app.json`)
2. Бот присылает кнопки с закрепленными за ним остановками
3. Водитель выбирает остановку
4. Если все успешно данные уходят в Google Таблицу

#### Удаление последней записи

- `/delete_last_entry` (или кнопка "Удалить последнюю запись"): Позволяет водителю удалить только свою последнюю запись и только за текущий день. Это нужно на случай ошибки ввода

#### Возможные ошибки для водителя

- Регистрация невозможна, если за водителем не закреплен автобус
- Регистрация невозможна, если для автобуса не добавлены остановки
- Регистрация невозможна, если в `app.json` указан неверный `time_zone`

### 4.4. Роль: Администратор

#### Команды

- `/my_details` (или кнопка "Мои данные"): Показывает информацию (Имя, ID, Роль)

#### Главное меню

Главное меню администратора предоставляет полный доступ к управлению системой через интерфейс бота:

- **Настройки пользователей:**
  - Добавление, удаление, изменение данных пользователей
  - Получение информации о пользователях

- **Настройки автобусов:**
  - Добавление, удаление автобусов
  - Добавление и управление остановками для каждого автобуса

- **Настройка Гугл Таблиц:**
  - Получение статистики и фильтрация данных
  - Очистка данных (удаление записей за первые N дней)

- **Настройки логирования:**
  - Получение файла `app.log` (он хранит в себе ошибки, предупреждения и некоторые изменения админа)
  - Очистка логов

- **Настройки приложения:**
  - Управление параметрами файла `app.json` (часовой пояс, лимиты пассажиров) прямо из бота

## Восстановление базы данных

Если у вас есть старая `data.db`, можно заменить файл `data/data.db` на вашу копию. После этого при запуске бот будет работать с вашей базой.

## Формат данных в Google таблице

Данные в Google таблице записываются в таком формате:

| Дата | Время | Имя | Номер автобуса | Остановка | Кол-во пассажиров |
|------|-------|-----|----------------|-----------|-------------------|